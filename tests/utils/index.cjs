'use strict';

var promises = require('fs/promises');
var path = require('path');
var cliHighlight = require('cli-highlight');
var t = require('chalk');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var t__default = /*#__PURE__*/_interopDefaultLegacy(t);

var H=Object.defineProperty;var B=(e,s)=>{for(var i in s)H(e,i,{get:s[i],enumerable:!0});};var F={};B(F,{dev:()=>U,forRule:()=>k,forSample:()=>G,getSample:()=>N});var C={keyword:t__default["default"].cyanBright,built_in:t__default["default"].cyanBright,type:t__default["default"].cyan.dim,literal:t__default["default"].hex("#ef3b7d"),number:t__default["default"].green,regexp:t__default["default"].red,string:t__default["default"].yellowBright,subst:t__default["default"].white,symbol:t__default["default"].white,class:t__default["default"].white,function:t__default["default"].cyanBright,title:t__default["default"].white,params:t__default["default"].white,comment:t__default["default"].gray,doctag:t__default["default"].green,meta:t__default["default"].white,"meta-keyword":t__default["default"].white,"meta-string":t__default["default"].white,section:t__default["default"].white,tag:t__default["default"].hex("#BECAFF"),name:e=>/(end)?comment/.test(e)?t__default["default"].gray(e):t__default["default"].hex("#FF93BC")(e),"builtin-name":t__default["default"].white,attr:t__default["default"].hex("#91EBC2"),attribute:t__default["default"].white,variable:t__default["default"].white,bullet:t__default["default"].white,code:t__default["default"].white,emphasis:t__default["default"].italic,strong:t__default["default"].bold,formula:t__default["default"].white,link:t__default["default"].underline,quote:t__default["default"].white,"selector-tag":t__default["default"].white,"selector-id":t__default["default"].white,"selector-class":t__default["default"].white,"selector-attr":t__default["default"].white,"selector-pseudo":t__default["default"].white,"template-tag":t__default["default"].white,"template-variable":t__default["default"].white,addition:t__default["default"].green,deletion:t__default["default"].red,default:cliHighlight.plain};function f(e){return e.replace(/(\x9B|\x1B\[)[0-?]*[ -\\/]*[@-~]/g,"")}function A(e){return t__default["default"].gray(f(e))}function v(e){return /{[{%]-?|-?[%}]}/.test(e)?e:t__default["default"].yellowBright(f(e))}function D(e){return f(e).replace(/-?\s*[a-zA-Z._]+/g,z).replace(/[|,.:]/g,s=>t__default["default"].hex("#e75378")(f(s))).replace(/(?:=|[!=]=|[<>]=?|(?:and|or|contains|with|in|null)\b)/g,_).replace(/["'][\s\S]*?["']/g,v)}function W(e){return /\./.test(e)?e.replace(/[a-zA-Z_.]*\.?/g,s=>t__default["default"].white(s)):/break|continue|else/.test(e)?t__default["default"].hex("#ef3b7d")(e):t__default["default"].white(e)}function L(e){return f(e).replace(/[a-zA-Z_]+\b[:]?/g,q).replace(/[|,.:]/g,s=>t__default["default"].hex("#e75378")(f(s))).replace(/["'][\s\S]*?["']/g,v)}function _(e){return /null|false|nil|true/.test(e)?t__default["default"].hex("#FF91E3")(e):t__default["default"].hex("#cb3f6e")(f(e))}function q(e){return /:$/.test(e)?t__default["default"].hex("#7ef0ff")(e):/\./.test(e)?W(e):t__default["default"].white(e)}function z(e){return /comment|endcomment/.test(e)?t__default["default"].gray(f(e)):t__default["default"].hex("#ef3b7d")(e)}function m(e,s={}){Object.assign(s,{theme:C,language:"html"});let i=cliHighlight.highlight(e,s);return s.language!=="html"?i:i.replace(/(?<={%-?)[\s\S]*?(?=-?%})/g,D).replace(/(?<={{)[\s\S]*?(?=}})/g,L).replace(/{{-|{%-|{{|{%|}}|%}|-}}|-%}/g,A)}var O=(e,s)=>{let i=function(n){return [e,"```js",JSON.stringify(n,null,2),"```"].join(`
`)};return s?i.description=[e,"```js",JSON.stringify(s,null,2),"```"].join(`
`):i.description=e,i},N=async e=>{let[s,i,r]=e.split("/"),n=path.join(process.cwd(),"tests",s,"samples",i,r.endsWith(".txt")?r:r+".txt"),o=await promises.readFile(n);if(!o)throw new Error("Sample file could not be located in: "+n);return o.toString()},U=e=>async(s,i)=>{let r=typeof s=="string"?path.join(process.cwd(),"tests",s):path.join(process.cwd(),"tests","dev.txt"),n=await promises.readFile(r);if(!n)throw new Error("Sample file could not be located in: "+r);let o=path.relative(process.cwd(),r),a=n.toString();if(e.log(t__default["default"].blueBright(o)),typeof i=="function")i(a,m),e.pass();else if(typeof s=="function")s(a,m),e.pass();else throw TypeError("Missing callback type")},k=(e,s)=>async(i,r)=>{if(Array.isArray(i)){let[n,o,a]=e.split("/"),p=path.join(process.cwd(),"tests",n,"samples",o,a.endsWith(".txt")?a:a+".txt");for(let g=0;g<i.length;g++){let c=i[g],w=await promises.readFile(p);if(!w)throw new Error("Sample file could not be located in: "+p);let l=w.toString();if(!l.trimStart().startsWith("---"))throw new Error("Missing description in sample file!");let h=l.indexOf("---",3);if(h<0)throw new Error("Missing closing description dashes, eg: ---");let S=`### Snapshot ${g+1}
`+l.slice(3,h).trim(),d=l.slice(h+3).trimStart();if(typeof c=="object"){let u=typeof s=="object"?{[s.lexer]:{...c}}:c;r.call({highlight(b,y){return m(b,y)}},d,u,O(S,u));}else r.call({highlight(u,b){return m(u,b)}},d,c,O(S));}}else {let n=Object.entries(i),[o,a]=e.split("/");for(let[p,g]of n){let c=path.join(process.cwd(),"tests",o,"samples",a,p.endsWith(".txt")?p:p+".txt"),w=await promises.readFile(c);if(!w)throw new Error("Sample file could not be located in: "+c);let l=w.toString();if(!l.trimStart().startsWith("---"))throw new Error("Missing description in sample file!");let h=l.indexOf("---",3);if(h<0)throw new Error("Missing closing description dashes, eg: ---");let S=l.slice(h+3).trimStart();for(let d=0;d<g.length;d++){let u=g[d],b=`### Snapshot ${d+1}
`+l.slice(3,h).trim();if(typeof u=="object"){let y=typeof s=="object"?{[s.lexer]:{...u}}:u;r.call({highlight(E,T){return m(E,T)}},S,y,O(b,y));}else r.call({highlight(y,E){return m(y,E)}},S,u,O(b));}}}},G=e=>async(s,i)=>{let[r,n]=e.split("/");for(let o=0;o<s.length;o++){let a=s[o],p=path.join(process.cwd(),"tests",r,"samples",n,a.endsWith(".txt")?a:a+".txt"),g=await promises.readFile(p);if(!g)throw new Error("Sample file could not be located in: "+p);let c=g.toString();if(!c.trimStart().startsWith("---"))throw new Error("Missing description in sample file!");let l=c.indexOf("---",3);if(l<0)throw new Error("Missing closing description dashes, eg: ---");let $=c.slice(l+3).trimStart(),h=`### Snapshot ${o+1}
`+c.slice(3,l).trim();i($,O(h));}};

module.exports = F;
